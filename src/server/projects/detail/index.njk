{% extends 'layouts/page.njk' %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/notification-banner/macro.njk" import govukNotificationBanner %}
{% from "govuk/components/tag/macro.njk" import govukTag %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}
{% from "status-tag.njk" import renderStatusTag %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      {{ appHeading({
        text: project.name,
        classes: "govuk-heading-xl govuk-!-margin-bottom-2 govuk-!-word-break-word"
      }) }}
      
      <div class="govuk-grid-row govuk-!-margin-top-4 govuk-!-margin-bottom-4">
        <div class="govuk-grid-column-two-thirds">
          {% if project.phase %}
            <p class="govuk-body-m"><strong>Phase:</strong> {{ project.phase }}</p>
          {% endif %}
          
          {% if project.defCode %}
            <p class="govuk-body-m"><strong>Project ID:</strong> {{ project.defCode }}</p>
          {% endif %}
          
          <h2 class="govuk-heading-m govuk-!-margin-top-4 inline-heading">
            Current delivery status:
            {{ renderStatusTag(project.status) }}
          </h2>
          
          {% set commentaryContent %}
            {% if project.commentary %}
              <p class="govuk-body">{{ project.commentary }}</p>
            {% endif %}
            {% if project.lastUpdated %}
              <p class="govuk-body-s govuk-!-margin-bottom-0">Last updated: {{ project.lastUpdated }}</p>
            {% endif %}
          {% endset %}
          {{ govukInsetText({
            html: commentaryContent
          }) }}
        </div>
      </div>
    </div>
  </div>

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      {% if isAuthenticated %}
        <p class="govuk-body govuk-!-margin-bottom-4">
          <a href="/projects/{{ project.id }}/manage" class="govuk-link">Manage project</a>
          <span class="govuk-!-margin-left-4">
            <a href="/projects/{{ project.id }}/assessment" class="govuk-link">Manage assessments</a>
          </span>
        </p>
      {% endif %}

      {% set complianceTabHtml %}
        <h2 class="govuk-heading-m">Service Standard Compliance</h2>
        
        {% if standards and standards.length > 0 %}
          <table class="govuk-table">
            <thead class="govuk-table__head">
              <tr class="govuk-table__row">
                <th scope="col" class="govuk-table__header">Standard</th>
                <th scope="col" class="govuk-table__header">Status</th>
              </tr>
            </thead>
            <tbody class="govuk-table__body">
              {% for standard in standards %}
                {% set standardSummary = null %}
                {% for summary in project.standardsSummary %}
                  {% if summary.standardId == standard.id %}
                    {% set standardSummary = summary %}
                  {% endif %}
                {% endfor %}
                
                <tr class="govuk-table__row">
                  <td class="govuk-table__cell">
                    <a href="/projects/{{ project.id }}/standards/{{ standard.id }}" class="govuk-link">
                      Standard {{ standard.number }}: {{ standard.name }}
                    </a>
                  </td>
                  <td class="govuk-table__cell">
                    {% if standardSummary %}
                      {{ renderStatusTag(standardSummary.aggregatedStatus or 'NOT_ASSESSED') }}
                    {% else %}
                      {{ renderStatusTag('NOT_ASSESSED') }}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="govuk-body">No service standards available.</p>
        {% endif %}
      {% endset %}

      {% set engagementTabHtml %}
        <h2 class="govuk-heading-m">Project Engagement</h2>
        <p class="govuk-body">Timeline content will be added here in the future.</p>
      {% endset %}

      {{ govukTabs({
        items: [
          {
            id: "compliance",
            label: "Service Standard compliance",
            panel: {
              html: complianceTabHtml
            }
          },
          {
            id: "engagement",
            label: "Project engagement",
            panel: {
              html: engagementTabHtml
            }
          }
        ]
      }) }}

    </div>
  </div>
{% endblock %}

{% block pageStyles %}
<style>
  .app-status-container {
    border: 2px solid #0b0c0c;
    padding: 15px;
    text-align: center;
  }
  
  .app-tag-list {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
  }
  
  .app-tag-list .govuk-tag {
    margin: 0;
    white-space: nowrap;
  }

  .inline-heading {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }
</style>
{% endblock %}